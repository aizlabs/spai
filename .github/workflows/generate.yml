name: Generate Spanish Learning Articles

on:
  schedule:
    # 3x daily: 2am, 10am, 6pm UTC
    - cron: '0 2 * * *'
    - cron: '0 10 * * *'
    - cron: '0 18 * * *'
  workflow_dispatch:  # Manual trigger button

# Prevent overlapping runs
concurrency:
  group: article-generation
  cancel-in-progress: false

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
      EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      ALERT_SMTP_HOST: ${{ secrets.ALERT_SMTP_HOST || 'smtp.gmail.com' }}
      ALERT_SMTP_PORT: ${{ secrets.ALERT_SMTP_PORT || 587 }}

    permissions:
      contents: write  # Needed to commit and push files

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache uv dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: |
          uv sync

      - name: Create output directories
        run: |
          mkdir -p output/_posts
          mkdir -p output/logs
          mkdir -p logs

      - name: Run content generation pipeline
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ENVIRONMENT: production
          ALERTS_ENABLED: ${{ secrets.ALERT_EMAIL != '' && secrets.EMAIL_USERNAME != '' && secrets.EMAIL_PASSWORD != '' }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
          ALERT_SENDER: AutoSpanishBot <noreply@github.com>
          ALERT_SMTP_HOST: ${{ secrets.ALERT_SMTP_HOST || 'smtp.gmail.com' }}
          ALERT_SMTP_PORT: ${{ secrets.ALERT_SMTP_PORT || 587 }}
          ALERT_SMTP_TLS: ${{ secrets.ALERT_SMTP_TLS || true }}
          ALERT_SMTP_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          ALERT_SMTP_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        run: |
          uv run spai-pipeline

      - name: Check for generated articles
        id: check_articles
        run: |
          if [ -n "$(git status --porcelain output/_posts/)" ]; then
            echo "has_articles=true" >> $GITHUB_OUTPUT
            echo "Generated $(git status --porcelain output/_posts/ | wc -l) new articles"
          else
            echo "has_articles=false" >> $GITHUB_OUTPUT
            echo "No new articles generated"
          fi

      - name: Commit and push generated articles
        if: steps.check_articles.outputs.has_articles == 'true'
        run: |
          git config user.name "AutoSpanishBot"
          git config user.email "bot@github.com"

          # Add generated articles (logs are gitignored)
          git add output/_posts/

          # Create commit with timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "Generate articles - $TIMESTAMP

          ü§ñ Automated content generation

          Generated with [Claude Code](https://claude.com/claude-code)"

          # Push to main branch
          git push origin main

      - name: Summary
        if: always()
        run: |
          echo "### Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_articles.outputs.has_articles }}" == "true" ]; then
            echo "‚úÖ **Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "üìù **Articles:** $(git diff --name-only HEAD~1 output/_posts/ 2>/dev/null | wc -l) generated" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Status:** No articles generated" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        # Run fallback email only when SMTP secrets are present; skip when missing to avoid auth failures
        if: ${{ failure() && env.EMAIL_USERNAME != '' && env.EMAIL_PASSWORD != '' && env.ALERT_EMAIL != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ env.ALERT_SMTP_HOST }}
          server_port: ${{ env.ALERT_SMTP_PORT }}
          # Port 587 expects STARTTLS; force non-implicit TLS so connection mode matches the port
          secure: false
          username: ${{ env.EMAIL_USERNAME }}
          password: ${{ env.EMAIL_PASSWORD }}
          subject: "‚ùå AutoSpanishBlog: Article generation failed"
          to: ${{ env.ALERT_EMAIL }}
          from: AutoSpanishBot <noreply@github.com>
          body: |
            Article generation pipeline failed.

            Run ID: ${{ github.run_id }}
            Workflow: ${{ github.workflow }}
            Triggered by: ${{ github.event_name }}
            Branch: ${{ github.ref_name }}

            Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ---
            AutoSpanishBlog Automation
